<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Melser UI Demo</title>
  <script type="module" src="/src/index.ts"></script>
  <style>
    /* ImportTheme Variables */
    @import url('./src/styles/theme.css');

    body {
      font-family: 'Inter', sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--me-bg);
      color: var(--me-text);
      transition: background-color 0.3s, color 0.3s;
    }

    h1,
    h2,
    h3 {
      color: var(--me-text);
    }

    .card {
      background: var(--me-surface);
      padding: 2rem;
      border-radius: var(--me-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      border: 1px solid var(--me-border);
    }

    .btn {
      background: var(--me-primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--me-radius);
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
      transition: opacity 0.2s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    pre {
      background: var(--me-input-bg);
      padding: 1rem;
      border-radius: var(--me-radius);
      overflow-x: auto;
      border: 1px solid var(--me-border);
      color: var(--me-text);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 100;
    }
  </style>
  <style>
    /* Component Overrides / Specifics */
    base-input {
      transition: all 0.2s ease;
    }

    base-input:hover {
      --base-input-border-color: var(--me-primary);
      --base-input-bg: var(--me-surface);
    }

    /* Ensure focus uses the primary color ring */
    base-input:focus-within {
      --base-input-border-color: var(--me-primary);
      --base-input-focus-ring-color: var(--me-primary);
    }
  </style>
</head>

<body>
  <div class="theme-toggle">
    <me-switch id="theme-switch" label="Dark Mode"></me-switch>
  </div>

  <h1>Melser UI Components</h1>

  <div class="card">
    <h2>Comprehensive Form Demo</h2>
    <form id="demo-form" onsubmit="event.preventDefault();">
      <div class="grid">
        <base-input name="username" label="Username" placeholder="Enter username" required></base-input>

        <base-input name="age" label="Age" type="number" placeholder="Enter age"></base-input>
      </div>

      <me-textarea name="bio" label="Biography" placeholder="Tell us about yourself..." rows="3"></me-textarea>

      <me-tags-input name="skills" label="Skills (Type and press Enter)"
        placeholder="e.g. JavaScript, Design"></me-tags-input>

      <me-file-upload name="avatar" label="Profile Picture" accept="image/*"></me-file-upload>

      <div class="grid">
        <me-password-input name="password" label="Password" placeholder="Enter password"
          required></me-password-input>
        <me-number-input name="experience" label="Years of Experience" min="0" max="50" step="1"
          value="2"></me-number-input>
      </div>

      <div class="grid">
        <me-date-picker name="birthdate" label="Date of Birth" required></me-date-picker>
        <me-time-picker name="preferred-time" label="Preferred Contact Time"></me-time-picker>
      </div>

      <div class="grid">
        <me-select name="role" label="Role" required></me-select>

        <me-multi-select name="interests" label="Interests"></me-multi-select>
      </div>

      <me-radio-group name="notification" label="Notification Preference" required></me-radio-group>

      <me-range name="satisfaction" label="Satisfaction Level" min="0" max="10" value="5"></me-range>

      <div class="grid">
        <me-switch name="newsletter" label="Subscribe to newsletter"></me-switch>

        <me-checkbox name="terms" label="I agree to the terms" required></me-checkbox>
      </div>

      <!-- New Components -->
      <h3 style="margin-top: 2rem; border-top: 1px solid var(--me-border); padding-top: 1rem;">
        Advanced Inputs
      </h3>

      <div class="grid">
        <me-otp-input name="otp" label="Verification Code (OTP)" length="6"></me-otp-input>
        <me-color-picker name="themeColor" label="Theme Color" value="#6366f1"></me-color-picker>
      </div>

      <div class="grid">
        <me-combobox name="country" label="Country (Combobox)" placeholder="Type to search..."></me-combobox>
        <me-rating name="rating" label="Product Rating" max="5"></me-rating>
      </div>

      <me-dual-range name="priceRange" label="Price Range" min="0" max="1000"
        value="[100, 500]"></me-dual-range>

      <!-- Custom Tag Name Demo -->
      <h3 style="margin-top: 2rem; border-top: 1px solid var(--me-border); padding-top: 1rem;">
        Custom Tag Name Demo
      </h3>
      <p style="font-size: 0.9rem; color: var(--me-text-secondary);">
        This is a &lt;custom-brand-switch&gt; registered dynamically:
      </p>
      <custom-brand-switch name="custom-feature" label="Enable Custom Feature"></custom-brand-switch>

      <!-- Validation Warning Demo -->
      <h3
        style="margin-top: 2rem; border-top: 1px solid var(--me-border); padding-top: 1rem; color: var(--me-warning);">
        Type Validation Demo (Check Console)
      </h3>
      <p style="font-size: 0.9rem; color: var(--me-text-secondary);">
        The following components have invalid values to trigger warnings:
      </p>

      <!-- Range expects number, receiving "invalid" -> NaN -->
      <me-range name="invalid-range" label="Invalid Range (Value='text')"
        value="text-instead-of-number"></me-range>

      <!-- Switch expects boolean, we'll force a string via JS below -->
      <me-switch id="invalid-switch" name="invalid-switch" label="Invalid Switch (Value='yes')"></me-switch>

      <button class="btn" id="submit-btn" type="button">Get Data & Validate</button>
    </form>

    <h3>Result (Zod-ready structure):</h3>
    <pre id="result">No data yet...</pre>
  </div>

  <div class="card">
    <h2>Schema Form Demo (@me-schema-form)</h2>
    <p>This form is generated entirely from a Zod schema.</p>
    <me-schema-form id="schema-form-demo"></me-schema-form>
    <h3>Submitted Data:</h3>
    <pre id="schema-form-output">No submit yet...</pre>
  </div>

  <div class="card">
    <h2>Data Table Demo</h2>
    <p>A powerful data table with sorting, pagination, selection, and inline editing.</p>
    
    <div style="margin-bottom: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
      <base-input id="table-search" placeholder="Search..." style="max-width: 300px; flex: 1;"></base-input>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
          <label style="font-size: 0.9rem;">Density:</label>
          <select id="table-density" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--me-border); background: var(--me-input-bg); color: var(--me-text);">
              <option value="Normal">Normal</option>
              <option value="Compact">Compact</option>
              <option value="Spacious">Spacious</option>
          </select>
      </div>
    </div>

    <data-table-lit id="demo-table"></data-table-lit>
    
    <div style="margin-top: 1rem;">
       <h3>Table Events Log:</h3>
       <pre id="table-output" style="max-height: 200px; overflow-y: auto;">Logs will appear here...</pre>
    </div>
  </div>

  <script type="module">
    import { registerComponent, MelserSwitch, setTheme } from '/src/index.ts';
    import { z } from 'zod';

    // DEMO: Register a component with a custom tag name
    registerComponent('custom-brand-switch', MelserSwitch);

    // DEMO: Force invalid type to trigger warning
    setTimeout(() => {
      const invalidSwitch = document.getElementById('invalid-switch');
      if (invalidSwitch) {
        // @ts-ignore - Forcing invalid type for demo
        invalidSwitch.value = "not-a-boolean";
      }
    }, 500);

    // Handle submit
    document.getElementById('submit-btn').addEventListener('click', () => {
      const inputs = document.querySelectorAll(
        `base-input, me-select, me-checkbox, me-range, 
         me-multi-select, me-radio-group, me-textarea, me-switch, 
         me-file-upload, me-tags-input, me-date-picker, me-time-picker, 
         me-number-input, me-password-input, me-otp-input, me-combobox, 
         me-color-picker, me-rating, me-dual-range, custom-brand-switch`
      );

      // 1. Extract raw data object { fieldName: value }
      const formData = {};

      inputs.forEach(el => {
        const data = el.getData();
        if (data.name) {
          formData[data.name] = data.value;
        }
      });

      // 2. Build Zod Schema Dynamically based on input type/name
      // This is a simplified heuristic for demonstration. 
      const schemaShape = {};

      inputs.forEach(el => {
        const name = el.getAttribute('name');
        if (!name) return;

        const tagName = el.tagName.toLowerCase();
        const type = el.getAttribute('type');
        const required = el.hasAttribute('required');

        let validator;

        // Determine base validator
        switch (tagName) {
          case 'me-number-input':
          case 'me-range':
          case 'me-rating':
            validator = z.coerce.number();
            break;
          case 'me-checkbox':
          case 'me-switch':
          case 'custom-brand-switch':
            validator = z.boolean();
            break;
          case 'me-multi-select':
          case 'me-tags-input':
          case 'me-dual-range': // Dual range returns array [min, max]
            validator = z.array(z.any());
            break;
          case 'me-date-picker':
            // value is typically string or Date object depending on implementation
            validator = z.string().or(z.date());
            break;
          default:
            validator = z.string();
        }

        // Add refinements
        // For strings, min(1) is usually what 'required' implies unless it can be empty
        if (required) {
          if (validator instanceof z.ZodString) {
            validator = validator.min(1, { message: "Field is required" });
          }
        } else {
          // If not required, allow optional (undefined) or empty string
          validator = validator.optional().or(z.literal(''));
        }

        // Special cases based on name (heuristic)
        if (name === 'email' || type === 'email') {
          validator = z.string().email();
        }

        schemaShape[name] = validator;
      });

      const schema = z.object(schemaShape);
      // 4. Validate Data
      const validationResult = schema.safeParse(formData);

      const output = {
        formData,
        validationResult: {
          success: validationResult.success,
          errors: validationResult.success ? null : validationResult.error.flatten()
        }
      };

      document.getElementById('result').textContent = JSON.stringify(output, null, 2);
    });
    // Theme Switching Logic
    const themeSwitch = document.getElementById('theme-switch');

    // Check system preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      themeSwitch.value = true;
      document.documentElement.setAttribute('data-theme', 'dark');
      setTheme('dark');
    }

    themeSwitch.addEventListener('ui:change', (e) => {
      const isDark = e.detail.value;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      setTheme(isDark ? 'dark' : 'light');
    });
  </script>

  <script type="module">
    import { z } from 'zod';

    // Populate options
    // Use requestAnimationFrame to ensure Custom Elements are upgraded
    requestAnimationFrame(() => {
      const roleSelect = document.querySelector('me-select[name="role"]');
      if (roleSelect) {
        roleSelect.options = [
          { label: 'Admin', value: 'admin' },
          { label: 'User', value: 'user' },
          { label: 'Guest', value: 'guest' }
        ];
      }

      const interestsSelect = document.querySelector('me-multi-select');
      if (interestsSelect) {
        interestsSelect.options = [
          { label: 'Coding', value: 'coding' },
          { label: 'Design', value: 'design' },
          { label: 'Music', value: 'music' },
          { label: 'Gaming', value: 'gaming' }
        ];
      }

      const radioGroup = document.querySelector('me-radio-group');
      if (radioGroup) {
        radioGroup.options = [
          { label: 'Email', value: 'email' },
          { label: 'SMS', value: 'sms' },
          { label: 'Push', value: 'push' }
        ];
      }

      const countryCombobox = document.querySelector('me-combobox');
      if (countryCombobox) {
        countryCombobox.options = [
          { label: 'United States', value: 'us' },
          { label: 'United Kingdom', value: 'uk' },
          { label: 'Canada', value: 'ca' },
          { label: 'Australia', value: 'au' },
          { label: 'Germany', value: 'de' },
          { label: 'France', value: 'fr' },
          { label: 'Japan', value: 'jp' },
          { label: 'Brazil', value: 'br' }
        ];
      }
    });

    // Schema Form Demo Initialization
    const schemaForm = document.getElementById('schema-form-demo');
    if (schemaForm) {
      const userSchema = z.object({
        fullName: z.string().min(2, "Name must be at least 2 characters"),
        age: z.number().min(18, "Must be at least 18"),
        role: z.enum(['Admin', 'Editor', 'Viewer']),
        isActive: z.boolean().default(true),
        birthDate: z.date().optional()
      });

      schemaForm.schema = userSchema;
      
      // Optional: Set initial data
      schemaForm.defaultData = {
        fullName: "John Doe",
        age: 25,
        role: 'Editor',
        isActive: true
      };

      schemaForm.addEventListener('submit', (e) => {
        const data = e.detail.data;
        document.getElementById('schema-form-output').textContent = JSON.stringify(data, null, 2);
      });
    }

    // Data Table Demo Initialization
    const demoTable = document.getElementById('demo-table');
    const tableLog = document.getElementById('table-output');
    
    function logTableEvent(msg) {
        if (!tableLog) return;
        const line = document.createElement('div');
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        line.style.borderBottom = '1px solid #333';
        line.style.padding = '4px 0';
        tableLog.prepend(line);
    }

    if (demoTable) {
        // 1. Define Columns
        demoTable.columns = [
            { key: 'id', label: 'ID', width: '50px', type: 'number', editable: false },
            { key: 'name', label: 'Name', type: 'string', editable: true },
            { key: 'role', label: 'Role', type: 'select', options: ['Admin', 'Manager', 'Developer', 'Designer'], editable: true },
            { key: 'status', label: 'Status', type: 'select', options: [{label: 'Active', value: 'active'}, {label: 'Inactive', value: 'inactive'}], render: (row) => {
                const colors = { active: '#22c55e', inactive: '#ef4444' };
                return document.createRange().createContextualFragment(`
                    <span style="color: ${colors[row.status] || 'white'}; font-weight: bold; text-transform: capitalize;">
                        ${row.status}
                    </span>
                `);
            }},
            { key: 'lastLogin', label: 'Last Login', type: 'date', editable: true },
            { key: 'verified', label: 'Verified', type: 'boolean', editable: true, align: 'center' },
            { key: 'actions', label: 'Actions', type: 'actions' }
        ];

        // 2. Define Data
        demoTable.data = [
            { id: 1, name: 'Alice Johnson', role: 'Admin', status: 'active', lastLogin: '2023-10-01', verified: true },
            { id: 2, name: 'Bob Smith', role: 'Developer', status: 'inactive', lastLogin: '2023-09-15', verified: false },
            { id: 3, name: 'Charlie Brown', role: 'Manager', status: 'active', lastLogin: '2023-10-05', verified: true },
            { id: 4, name: 'Diana Prince', role: 'Designer', status: 'active', lastLogin: '2023-10-10', verified: true },
            { id: 5, name: 'Evan Wright', role: 'Developer', status: 'active', lastLogin: '2023-10-12', verified: false },
            { id: 6, name: 'Fiona Gallagher', role: 'Manager', status: 'inactive', lastLogin: '2023-08-20', verified: true },
            { id: 7, name: 'George Harrison', role: 'Developer', status: 'active', lastLogin: '2023-10-14', verified: true },
            { id: 8, name: 'Hannah Abbott', role: 'Designer', status: 'inactive', lastLogin: '2023-09-30', verified: false },
        ];

        // 3. Configure
        demoTable.config = {
            pagination: true,
            pageSize: 5,
            selection: true,
            expandable: true,
            density: 'Normal'
        };

        // 4. Handle Search
        const searchInput = document.getElementById('table-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                demoTable.searchQuery = e.target.value;
            });
        }

        // 5. Handle Configuration Changes
        document.getElementById('table-density')?.addEventListener('change', (e) => {
            demoTable.config = { ...demoTable.config, density: e.target.value };
        });

        // 6. Listen to Events
        demoTable.addEventListener('selection-change', (e) => {
            logTableEvent(`Selection changed: ${JSON.stringify(e.detail.selectedIds)}`);
        });

        demoTable.addEventListener('row-save', (e) => {
            logTableEvent(`Row Saved (ID: ${e.detail.id}): ${JSON.stringify(e.detail.data)}`);
            // Update local data to reflect changes
            const index = demoTable.data.findIndex(r => r.id === e.detail.id);
            if (index !== -1) {
                demoTable.data[index] = { ...demoTable.data[index], ...e.detail.data };
                demoTable.data = [...demoTable.data]; // Trigger re-render
                logTableEvent(`Data updated locally.`);
            }
        });

        demoTable.addEventListener('row-action', (e) => {
          console.log(e.detail);
            logTableEvent(`Action: ${e.detail.action} on ID: ${e.detail.id}`);
            if (e.detail.action === 'delete') {
                if(confirm('Are you sure you want to delete this row?')) {
                    demoTable.data = demoTable.data.filter(r => r.id !== e.detail.id);
                    logTableEvent(`Row ${e.detail.id} deleted.`);
                }
            }
        });

        // Add details slot content dynamically if needed, or use named slots in template
        // For this demo, we can just rely on the 'details-[id]' slot convention
        // But since we are in a script tag, we might want to inject slots into the light DOM of the table
        // However, the table component renders slots inside its shadow root, so we place them as children of the custom element
        
        demoTable.data.forEach(row => {
            const div = document.createElement('div');
            div.setAttribute('slot', `details-${row.id}`);
            div.style.padding = '1rem';
            div.style.color = 'var(--me-text-secondary)';
            div.innerHTML = `<strong>Details for ${row.name}:</strong><br>
                             This is an expandable details row. You can put any content here.<br>
                             ID: ${row.id}, Role: ${row.role}`;
            demoTable.appendChild(div);
        });
    }
  </script>
</body>

</html>