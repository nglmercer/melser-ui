<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Melser UI Demo</title>
  <script type="module" src="/src/index.ts"></script>
  <style>
    /* ImportTheme Variables */
    @import url('./src/styles/theme.css');

    body {
      font-family: 'Inter', sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
      background-color: var(--me-bg);
      color: var(--me-text);
      transition: background-color 0.3s, color 0.3s;
    }

    h1,
    h2,
    h3 {
      color: var(--me-text);
    }

    .card {
      background: var(--me-surface);
      padding: 2rem;
      border-radius: var(--me-radius);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
      border: 1px solid var(--me-border);
    }

    .btn {
      background: var(--me-primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--me-radius);
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
      transition: opacity 0.2s;
    }

    .btn:hover {
      opacity: 0.9;
    }

    pre {
      background: var(--me-input-bg);
      padding: 1rem;
      border-radius: var(--me-radius);
      overflow-x: auto;
      border: 1px solid var(--me-border);
      color: var(--me-text);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 100;
    }
  </style>
</head>

<body>
  <div class="theme-toggle">
    <me-switch id="theme-switch" label="Dark Mode"></me-switch>
  </div>

  <h1>Melser UI Components</h1>

  <div class="card">
    <h2>Comprehensive Form Demo</h2>
    <form id="demo-form" onsubmit="event.preventDefault();">
      <div class="grid">
        <base-input name="username" label="Username" placeholder="Enter username" required></base-input>

        <base-input name="age" label="Age" type="number" placeholder="Enter age"></base-input>
      </div>

      <me-textarea name="bio" label="Biography" placeholder="Tell us about yourself..." rows="3"></me-textarea>

      <me-tags-input name="skills" label="Skills (Type and press Enter)"
        placeholder="e.g. JavaScript, Design"></me-tags-input>

      <me-file-upload name="avatar" label="Profile Picture" accept="image/*"></me-file-upload>

      <div class="grid">
        <me-password-input name="password" label="Password" placeholder="Enter password"
          required></me-password-input>
        <me-number-input name="experience" label="Years of Experience" min="0" max="50" step="1"
          value="2"></me-number-input>
      </div>

      <div class="grid">
        <me-date-picker name="birthdate" label="Date of Birth" required></me-date-picker>
        <me-time-picker name="preferred-time" label="Preferred Contact Time"></me-time-picker>
      </div>

      <div class="grid">
        <me-select name="role" label="Role" required></me-select>

        <me-multi-select name="interests" label="Interests"></me-multi-select>
      </div>

      <me-radio-group name="notification" label="Notification Preference" required></me-radio-group>

      <me-range name="satisfaction" label="Satisfaction Level" min="0" max="10" value="5"></me-range>

      <div class="grid">
        <me-switch name="newsletter" label="Subscribe to newsletter"></me-switch>

        <me-checkbox name="terms" label="I agree to the terms" required></me-checkbox>
      </div>

      <!-- New Components -->
      <h3 style="margin-top: 2rem; border-top: 1px solid var(--me-border); padding-top: 1rem;">
        Advanced Inputs
      </h3>

      <div class="grid">
        <me-otp-input name="otp" label="Verification Code (OTP)" length="6"></me-otp-input>
        <me-color-picker name="themeColor" label="Theme Color" value="#6366f1"></me-color-picker>
      </div>

      <div class="grid">
        <me-combobox name="country" label="Country (Combobox)" placeholder="Type to search..."></me-combobox>
        <me-rating name="rating" label="Product Rating" max="5"></me-rating>
      </div>

      <me-dual-range name="priceRange" label="Price Range" min="0" max="1000"
        value="[100, 500]"></me-dual-range>

      <!-- Custom Tag Name Demo -->
      <h3 style="margin-top: 2rem; border-top: 1px solid var(--me-border); padding-top: 1rem;">
        Custom Tag Name Demo
      </h3>
      <p style="font-size: 0.9rem; color: var(--me-text-secondary);">
        This is a &lt;custom-brand-switch&gt; registered dynamically:
      </p>
      <custom-brand-switch name="custom-feature" label="Enable Custom Feature"></custom-brand-switch>

      <!-- Validation Warning Demo -->
      <h3
        style="margin-top: 2rem; border-top: 1px solid var(--me-border); padding-top: 1rem; color: var(--me-warning);">
        Type Validation Demo (Check Console)
      </h3>
      <p style="font-size: 0.9rem; color: var(--me-text-secondary);">
        The following components have invalid values to trigger warnings:
      </p>

      <!-- Range expects number, receiving "invalid" -> NaN -->
      <me-range name="invalid-range" label="Invalid Range (Value='text')"
        value="text-instead-of-number"></me-range>

      <!-- Switch expects boolean, we'll force a string via JS below -->
      <me-switch id="invalid-switch" name="invalid-switch" label="Invalid Switch (Value='yes')"></me-switch>

      <button class="btn" id="submit-btn" type="button">Get Data & Validate</button>
    </form>

    <h3>Result (Zod-ready structure):</h3>
    <pre id="result">No data yet...</pre>
  </div>

  <div class="card">
    <h2>Schema Form Demo (@me-schema-form)</h2>
    <p>This form is generated entirely from a Zod schema.</p>
    <me-schema-form id="schema-form-demo"></me-schema-form>
    <h3>Submitted Data:</h3>
    <pre id="schema-form-output">No submit yet...</pre>
  </div>

  <script type="module">
    import { registerComponent, MelserSwitch, setTheme } from '/src/index.ts';
    import { z } from 'zod';
    import { zodToJsonSchema } from "zod-to-json-schema";

    // DEMO: Register a component with a custom tag name
    registerComponent('custom-brand-switch', MelserSwitch);

    // DEMO: Force invalid type to trigger warning
    setTimeout(() => {
      const invalidSwitch = document.getElementById('invalid-switch');
      if (invalidSwitch) {
        // @ts-ignore - Forcing invalid type for demo
        invalidSwitch.value = "not-a-boolean";
      }
    }, 500);

    // Handle submit
    document.getElementById('submit-btn').addEventListener('click', () => {
      const inputs = document.querySelectorAll(
        `base-input, me-select, me-checkbox, me-range, 
         me-multi-select, me-radio-group, me-textarea, me-switch, 
         me-file-upload, me-tags-input, me-date-picker, me-time-picker, 
         me-number-input, me-password-input, me-otp-input, me-combobox, 
         me-color-picker, me-rating, me-dual-range, custom-brand-switch`
      );

      // 1. Extract raw data object { fieldName: value }
      const formData = {};

      inputs.forEach(el => {
        const data = el.getData();
        if (data.name) {
          formData[data.name] = data.value;
        }
      });

      // 2. Build Zod Schema Dynamically based on input type/name
      // This is a simplified heuristic for demonstration. 
      const schemaShape = {};

      inputs.forEach(el => {
        const name = el.getAttribute('name');
        if (!name) return;

        const tagName = el.tagName.toLowerCase();
        const type = el.getAttribute('type');
        const required = el.hasAttribute('required');

        let validator;

        // Determine base validator
        switch (tagName) {
          case 'me-number-input':
          case 'me-range':
          case 'me-rating':
            validator = z.coerce.number();
            break;
          case 'me-checkbox':
          case 'me-switch':
          case 'custom-brand-switch':
            validator = z.boolean();
            break;
          case 'me-multi-select':
          case 'me-tags-input':
          case 'me-dual-range': // Dual range returns array [min, max]
            validator = z.array(z.any());
            break;
          case 'me-date-picker':
            // value is typically string or Date object depending on implementation
            validator = z.string().or(z.date());
            break;
          default:
            validator = z.string();
        }

        // Add refinements
        // For strings, min(1) is usually what 'required' implies unless it can be empty
        if (required) {
          if (validator instanceof z.ZodString) {
            validator = validator.min(1, { message: "Field is required" });
          }
        } else {
          // If not required, allow optional (undefined) or empty string
          validator = validator.optional().or(z.literal(''));
        }

        // Special cases based on name (heuristic)
        if (name === 'email' || type === 'email') {
          validator = z.string().email();
        }

        schemaShape[name] = validator;
      });

      const schema = z.object(schemaShape);

      // 3. Convert to JSON Schema
      const jsonSchema = zodToJsonSchema(schema, "myDemoForm");

      // 4. Validate Data
      const validationResult = schema.safeParse(formData);

      const output = {
        formData,
        validationResult: {
          success: validationResult.success,
          errors: validationResult.success ? null : validationResult.error.flatten()
        },
        generatedJsonSchema: jsonSchema
      };

      document.getElementById('result').textContent = JSON.stringify(output, null, 2);
    });
    // Theme Switching Logic
    const themeSwitch = document.getElementById('theme-switch');

    // Check system preference
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      themeSwitch.value = true;
      document.documentElement.setAttribute('data-theme', 'dark');
      setTheme('dark');
    }

    themeSwitch.addEventListener('ui:change', (e) => {
      const isDark = e.detail.value;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      setTheme(isDark ? 'dark' : 'light');
    });
  </script>

  <script type="module">
    import { z } from 'zod';

    // Populate options
    // Use requestAnimationFrame to ensure Custom Elements are upgraded
    requestAnimationFrame(() => {
      const roleSelect = document.querySelector('me-select[name="role"]');
      if (roleSelect) {
        roleSelect.options = [
          { label: 'Admin', value: 'admin' },
          { label: 'User', value: 'user' },
          { label: 'Guest', value: 'guest' }
        ];
      }

      const interestsSelect = document.querySelector('me-multi-select');
      if (interestsSelect) {
        interestsSelect.options = [
          { label: 'Coding', value: 'coding' },
          { label: 'Design', value: 'design' },
          { label: 'Music', value: 'music' },
          { label: 'Gaming', value: 'gaming' }
        ];
      }

      const radioGroup = document.querySelector('me-radio-group');
      if (radioGroup) {
        radioGroup.options = [
          { label: 'Email', value: 'email' },
          { label: 'SMS', value: 'sms' },
          { label: 'Push', value: 'push' }
        ];
      }

      const countryCombobox = document.querySelector('me-combobox');
      if (countryCombobox) {
        countryCombobox.options = [
          { label: 'United States', value: 'us' },
          { label: 'United Kingdom', value: 'uk' },
          { label: 'Canada', value: 'ca' },
          { label: 'Australia', value: 'au' },
          { label: 'Germany', value: 'de' },
          { label: 'France', value: 'fr' },
          { label: 'Japan', value: 'jp' },
          { label: 'Brazil', value: 'br' }
        ];
      }
    });

    // Schema Form Demo Initialization
    const schemaForm = document.getElementById('schema-form-demo');
    if (schemaForm) {
      const userSchema = z.object({
        fullName: z.string().min(2, "Name must be at least 2 characters"),
        age: z.number().min(18, "Must be at least 18"),
        role: z.enum(['Admin', 'Editor', 'Viewer']),
        isActive: z.boolean().default(true),
        birthDate: z.date().optional()
      });

      schemaForm.schema = userSchema;
      
      // Optional: Set initial data
      schemaForm.defaultData = {
        fullName: "John Doe",
        age: 25,
        role: 'Editor',
        isActive: true
      };

      schemaForm.addEventListener('submit', (e) => {
        const data = e.detail.data;
        document.getElementById('schema-form-output').textContent = JSON.stringify(data, null, 2);
      });
    }
  </script>
</body>

</html>